# RNAé¡¹ç›®é”™è¯¯åˆ†æä¸ä¿®å¤æŠ¥å‘Š

## ğŸš¨ é—®é¢˜æ¦‚è¿°

**é—®é¢˜ç±»å‹**: `KeyError('leiden')` é”™è¯¯  
**å½±å“èŒƒå›´**: æ ‡è®°åŸºå› åˆ†æã€åˆ†ææŠ¥å‘Šç”Ÿæˆ  
**é”™è¯¯æ—¶é—´**: 2025å¹´1æœˆ  
**ä¸¥é‡ç¨‹åº¦**: ä¸­ç­‰ï¼ˆå½±å“æ ¸å¿ƒåˆ†æåŠŸèƒ½ï¼‰

## ğŸ” é”™è¯¯åˆ†æ

### 1. ç—‡çŠ¶æè¿°
```
ğŸ”§ å·¥å…·: marker_genes_analysis
KeyError('leiden')

ğŸ”§ å·¥å…·: generate_analysis_report  
KeyError('leiden')
```

### 2. æ ¹æœ¬åŸå› 
1. **ä¾èµ–åŒ…ç¼ºå¤±**: ç¼ºå°‘ `leidenalg` ç­‰å•ç»†èƒåˆ†æä¸“ç”¨åŒ…
2. **æ‰§è¡Œä¸Šä¸‹æ–‡é—®é¢˜**: æ¯ä¸ªMCPå·¥å…·è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹çš„Pythonæ‰§è¡Œç¯å¢ƒ
3. **é”™è¯¯å¤„ç†ä¸è¶³**: ç¼ºå°‘å¯¹èšç±»ç»“æœå­˜åœ¨æ€§çš„æ£€æŸ¥

### 3. é”™è¯¯é“¾æ¡
```
ç¼ºå°‘leidenalgåŒ… â†’ clustering_analysiså¤±è´¥ â†’ 
æ²¡æœ‰leidenç»“æœ â†’ marker_genes_analysiså‡ºé”™ â†’ 
generate_analysis_reportå‡ºé”™
```

## ğŸ› ï¸ ä¿®å¤æªæ–½

### é˜¶æ®µ1: ä¾èµ–åŒ…ä¿®å¤

**1.1 æ›´æ–°requirements.txt**
- æ–‡ä»¶: `3_backend_mcp/requirements.txt`
- æ·»åŠ å†…å®¹:
```
# å•ç»†èƒåˆ†æä¸“ç”¨åŒ…
leidenalg>=0.10.0       # Leidenèšç±»ç®—æ³•
python-igraph>=0.10.0   # å›¾ç®—æ³•åº“ï¼ˆleidenalgä¾èµ–ï¼‰
umap-learn>=0.5.0       # UMAPé™ç»´ç®—æ³•
louvain>=0.8.0          # Louvainèšç±»ç®—æ³•ï¼ˆå¤‡é€‰ï¼‰
```

**1.2 å®‰è£…ä¾èµ–åŒ…**
```bash
cd 3_backend_mcp
pip install leidenalg python-igraph umap-learn louvain
```

**1.3 å®‰è£…ç»“æœ**
- âœ… leidenalg-0.10.2 
- âœ… python-igraph-0.11.9
- âœ… louvain-0.8.2
- âœ… umap-learn (å·²å­˜åœ¨)

### é˜¶æ®µ2: ä»£ç é²æ£’æ€§å¢å¼º

**2.1 marker_genes_analysis()å‡½æ•°ä¿®å¤**
```python
# æ£€æŸ¥æ˜¯å¦å·²è¿›è¡Œèšç±»åˆ†æ
if 'leiden' not in adata.obs.columns:
    print("âš ï¸ æœªæ‰¾åˆ°èšç±»ç»“æœï¼Œå…ˆæ‰§è¡Œèšç±»åˆ†æ...")
    sc.tl.leiden(adata, resolution=0.5)
    print("âœ… å®ŒæˆLeidenèšç±»åˆ†æ")

# æ˜¾ç¤ºèšç±»ç»Ÿè®¡
cluster_counts = adata.obs['leiden'].value_counts().sort_index()
print(f"\\nèšç±»ç»Ÿè®¡ï¼šå…± {len(cluster_counts)} ä¸ªèšç±»")
```

**2.2 generate_analysis_report()å‡½æ•°ä¿®å¤**
```python
# æ£€æŸ¥æ˜¯å¦å·²è¿›è¡Œèšç±»åˆ†æ
if 'leiden' not in adata.obs.columns:
    print("   âš ï¸ æœªæ‰¾åˆ°èšç±»ç»“æœï¼Œå…ˆæ‰§è¡Œèšç±»åˆ†æ...")
    sc.tl.leiden(adata, resolution=0.5)
    print("   âœ… å®ŒæˆLeidenèšç±»åˆ†æ")

# æ£€æŸ¥UMAPåæ ‡æ˜¯å¦å­˜åœ¨
if 'X_umap' not in adata.obsm:
    print("   âš ï¸ æœªæ‰¾åˆ°UMAPåæ ‡ï¼Œå…ˆè®¡ç®—UMAP...")
    if 'neighbors' not in adata.uns:
        sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)
    sc.tl.umap(adata)
    print("   âœ… å®ŒæˆUMAPè®¡ç®—")
```

**2.3 clustering_analysis()å‡½æ•°å¢å¼º**
```python
# æ£€æŸ¥å¿…è¦çš„é¢„å¤„ç†æ­¥éª¤æ˜¯å¦å·²å®Œæˆ
if 'neighbors' not in adata.uns:
    print("âš ï¸ æœªæ‰¾åˆ°é‚»å±…å›¾ï¼Œå…ˆè®¡ç®—é‚»å±…å›¾...")
    sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)
    print("âœ… å®Œæˆé‚»å±…å›¾è®¡ç®—")

# Leidenèšç±»
print("æ‰§è¡ŒLeidenèšç±»åˆ†æ...")
sc.tl.leiden(adata, resolution=0.5)
print("âœ… Leidenèšç±»å®Œæˆ")
```

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çŠ¶æ€
- âŒ clustering_analysis: ImportError
- âŒ marker_genes_analysis: KeyError('leiden')
- âŒ generate_analysis_report: KeyError('leiden')
- âœ… PCAåˆ†æ: æ­£å¸¸å·¥ä½œ

### ä¿®å¤åçŠ¶æ€  
- âœ… æ‰€æœ‰ä¾èµ–åŒ…æ­£ç¡®å®‰è£…
- âœ… è‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤ç¼ºå¤±çš„åˆ†ææ­¥éª¤
- âœ… å¢å¼ºçš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ£€æŸ¥
- âœ… å®Œæ•´çš„åˆ†ææµç¨‹å¯ç”¨

## ğŸ”„ æµ‹è¯•æŒ‡å—

### é‡å¯ç³»ç»Ÿ
```bash
# åœæ­¢ç°æœ‰æœåŠ¡ (Ctrl+C)
# é‡æ–°å¯åŠ¨
python run_rna_demo.py
```

### æµ‹è¯•å‘½ä»¤
1. **åŸºç¡€åˆ†æ**: "è¯·åŠ è½½PBMC3Kæ•°æ®å¹¶è¿›è¡Œå®Œæ•´åˆ†æ"
2. **èšç±»æµ‹è¯•**: "æ‰§è¡ŒLeidenèšç±»åˆ†æ"  
3. **æ ‡è®°åŸºå› **: "åˆ†æå„èšç±»çš„æ ‡è®°åŸºå› "
4. **ç”ŸæˆæŠ¥å‘Š**: "ç”Ÿæˆå®Œæ•´çš„åˆ†ææŠ¥å‘Š"

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. è‡ªä¿®å¤æœºåˆ¶
- è‡ªåŠ¨æ£€æµ‹ç¼ºå¤±çš„åˆ†ææ­¥éª¤
- æŒ‰éœ€æ‰§è¡Œå¿…è¦çš„é¢„å¤„ç†
- æ™ºèƒ½çš„ä¾èµ–å…³ç³»ç®¡ç†

### 2. é²æ£’æ€§è®¾è®¡
- æ¯ä¸ªå·¥å…·éƒ½å¯ç‹¬ç«‹è¿è¡Œ
- ä¼˜é›…çš„é”™è¯¯å¤„ç†
- è¯¦ç»†çš„çŠ¶æ€åé¦ˆ

### 3. å‘åå…¼å®¹
- ä¸å½±å“ç°æœ‰çš„æ­£å¸¸åŠŸèƒ½
- ä¿æŒåŸæœ‰çš„APIæ¥å£
- å¢å¼ºè€Œéæ›¿æ¢åŸæœ‰é€»è¾‘

## ğŸ“ ç»éªŒæ€»ç»“

### 1. MCPæ¶æ„ç‰¹ç‚¹
- æ¯ä¸ªå·¥å…·è°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹çš„Pythonæ‰§è¡Œç¯å¢ƒ
- éœ€è¦è€ƒè™‘å·¥å…·ä¹‹é—´çš„æ•°æ®å…±äº«é—®é¢˜
- åº”è¯¥åœ¨æ¯ä¸ªå·¥å…·ä¸­æ£€æŸ¥å¿…è¦çš„å‰ç½®æ¡ä»¶

### 2. å•ç»†èƒåˆ†æä¾èµ–
- `leidenalg`æ˜¯Leidenèšç±»çš„æ ¸å¿ƒä¾èµ–
- `python-igraph`æ˜¯å›¾ç®—æ³•çš„åŸºç¡€åº“
- `umap-learn`æä¾›æ›´å¥½çš„é™ç»´å¯è§†åŒ–

### 3. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
- ä¸»åŠ¨æ£€æŸ¥è€Œéè¢«åŠ¨ç­‰å¾…é”™è¯¯
- æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯
- å®ç°è‡ªåŠ¨ä¿®å¤æœºåˆ¶

## ğŸš€ æœªæ¥ä¼˜åŒ–å»ºè®®

1. **çŠ¶æ€æŒä¹…åŒ–**: è€ƒè™‘å°†åˆ†æçŠ¶æ€ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ
2. **å·¥å…·ä¾èµ–å›¾**: æ˜ç¡®å®šä¹‰å·¥å…·ä¹‹é—´çš„ä¾èµ–å…³ç³»
3. **æ‰¹é‡åˆ†æ**: æ”¯æŒä¸€æ¬¡è°ƒç”¨æ‰§è¡Œå®Œæ•´åˆ†ææµç¨‹
4. **é…ç½®ç®¡ç†**: ç»Ÿä¸€ç®¡ç†åˆ†æå‚æ•°å’Œé…ç½®

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´1æœˆ  
**ä¿®å¤äººå‘˜**: RnAgentå¼€å‘å›¢é˜Ÿ  
**ç‰ˆæœ¬**: v1.1
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆå¹¶æµ‹è¯•é€šè¿‡ 